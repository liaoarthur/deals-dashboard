<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deals Dashboard with Lookalikes</title>

    <!-- Design System -->
    <link rel="stylesheet" href="/design-system.css">

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* One-off: lookalike card header layout (not worth a global class) */
        .lookalike-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Set API_BASE_URL for production (Vercel injects this via inject-env.js) -->
    <script>
        window.API_BASE_URL = 'https://web-production-768f7.up.railway.app';
    </script>

    <script type="text/babel">
        const API_BASE_URL = window.API_BASE_URL;
        const { useState, useEffect, useRef } = React;

        // ─── Auth: check session on page load, redirect to login if not authenticated ───
        (async function checkAuth() {
            try {
                const resp = await fetch(`${API_BASE_URL}/api/check-auth`, { credentials: 'include' });
                if (resp.status === 401 || !resp.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                const data = await resp.json();
                if (!data.authenticated) {
                    window.location.href = '/login.html';
                }
            } catch (e) {
                window.location.href = '/login.html';
            }
        })();

        async function handleLogout() {
            try {
                await fetch(`${API_BASE_URL}/api/logout`, { method: 'POST', credentials: 'include' });
            } catch (e) {
                // ignore — redirect regardless
            }
            window.location.href = '/login.html';
        }

        function LookalikeCard({ org }) {
            const [contactsOpen, setContactsOpen] = useState(false);
            const [claySent, setClaySent] = useState(false);
            const [claySending, setClaySending] = useState(false);
            const contacts = org.contacts || [];

            // ── Clay Contact Search state (per-lookalike company) ──
            const [clayContacts, setClayContacts] = useState(null);
            const [loadingClaySearch, setLoadingClaySearch] = useState(false);
            const [showRerunPrompt, setShowRerunPrompt] = useState(false);
            const [cachedSearchResult, setCachedSearchResult] = useState(null);
            const [claySearchError, setClaySearchError] = useState(null);
            const clayPollRef = React.useRef(null);

            const searchClayContacts = async (force = false) => {
                const domain = org.website;
                if (!domain) {
                    setClaySearchError('No website/domain on this company — cannot search Clay');
                    return;
                }

                setLoadingClaySearch(true);
                setClaySearchError(null);
                setShowRerunPrompt(false);

                try {
                    if (!force) {
                        const checkResp = await fetch(`${API_BASE_URL}/api/check-clay-search`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ domain }),
                        });
                        if (checkResp.status === 401) { window.location.href = '/login.html'; return; }
                        const checkData = await checkResp.json();

                        if (checkData.found && checkData.status === 'complete') {
                            setClayContacts(checkData.contacts || []);
                            setCachedSearchResult(checkData);
                            setShowRerunPrompt(true);
                            setLoadingClaySearch(false);
                            return;
                        }

                        if (checkData.found && checkData.status === 'searching') {
                            startClayPolling(checkData.company_key);
                            return;
                        }
                    }

                    const triggerResp = await fetch(`${API_BASE_URL}/api/trigger-clay-search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            domain,
                            company_name: org.name || '',
                            state: org.state || '',
                            city: org.city || '',
                            specialty: org.specialty || '',
                            force,
                        }),
                    });
                    const triggerData = await triggerResp.json();

                    if (triggerData.error) {
                        setClaySearchError(triggerData.error);
                        setLoadingClaySearch(false);
                        return;
                    }

                    if (triggerData.already_cached) {
                        searchClayContacts(false);
                        return;
                    }

                    startClayPolling(triggerData.company_key);

                } catch (e) {
                    console.error('[Clay Search] Error:', e);
                    setClaySearchError('Failed to search contacts');
                    setLoadingClaySearch(false);
                }
            };

            const startClayPolling = (companyKey) => {
                if (clayPollRef.current) clearInterval(clayPollRef.current);
                let pollCount = 0;
                const maxPolls = 40;

                clayPollRef.current = setInterval(async () => {
                    pollCount++;
                    try {
                        const resp = await fetch(`${API_BASE_URL}/api/clay-search-status/${companyKey}`, { credentials: 'include' });
                        const data = await resp.json();

                        if (data.contacts && data.contacts.length > 0) {
                            setClayContacts(data.contacts);
                        }

                        if (data.status === 'complete' || pollCount >= maxPolls) {
                            clearInterval(clayPollRef.current);
                            clayPollRef.current = null;
                            setClayContacts(data.contacts || []);
                            setCachedSearchResult(data);
                            setShowRerunPrompt(true);
                            setLoadingClaySearch(false);
                        }
                    } catch (e) {
                        console.error('[Clay Poll] Error:', e);
                        clearInterval(clayPollRef.current);
                        clayPollRef.current = null;
                        setClaySearchError('Polling failed — try again');
                        setLoadingClaySearch(false);
                    }
                }, 3000);
            };

            React.useEffect(() => {
                return () => { if (clayPollRef.current) clearInterval(clayPollRef.current); };
            }, []);

            const seedClayCompany = async () => {
                setClaySending(true);
                try {
                    const resp = await fetch(`${API_BASE_URL}/api/clay-seed`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            company_name: org.name || '',
                            company_domain: org.website || '',
                            state: org.state || '',
                            city: org.city || '',
                            country: org.country || '',
                            specialty: org.specialty || '',
                            physician_count: org.physician_count || '',
                            ehr: org.ehr || '',
                            definitive_id: org.definitive_id || '',
                            similarity_score: org.similarity_score || '',
                            source: 'lookalike',
                        })
                    });
                    const data = await resp.json();
                    if (data.success) setClaySent(true);
                } catch (e) {
                    console.error('Clay seed error:', e);
                } finally {
                    setClaySending(false);
                }
            };

            const EmailList = ({ c }) => {
                const emails = [
                    c.direct_email_primary && { label: 'Direct', value: c.direct_email_primary },
                    c.direct_email_secondary && { label: 'Direct 2', value: c.direct_email_secondary },
                    c.business_email && { label: 'Work', value: c.business_email },
                ].filter(Boolean);
                if (emails.length === 0) return <span className="text-muted">—</span>;
                return (
                    <span>
                        {emails.map((e, i) => (
                            <span key={i}>
                                {i > 0 && <br/>}
                                <a href={`mailto:${e.value}`} title={e.label}>{e.value}</a>
                            </span>
                        ))}
                    </span>
                );
            };

            const PhoneList = ({ c }) => {
                const phones = [
                    c.mobile_phone_primary && { label: 'Mobile', value: c.mobile_phone_primary },
                    c.mobile_phone_secondary && { label: 'Mobile 2', value: c.mobile_phone_secondary },
                ].filter(Boolean);
                if (phones.length === 0) return <span className="text-muted">—</span>;
                return (
                    <span>
                        {phones.map((p, i) => (
                            <span key={i}>
                                {i > 0 && <br/>}
                                {p.value}
                            </span>
                        ))}
                    </span>
                );
            };

            return (
                <div className="lookalike-card">
                    <div className="lookalike-card-header">
                        <h5>{org.name}</h5>
                        <button
                            className="clay-seed-btn"
                            onClick={seedClayCompany}
                            disabled={claySending || claySent}
                            title="Send to Clay for contact enrichment"
                        >
                            {claySending ? '...' : claySent ? 'Sent' : 'Clay'}
                        </button>
                    </div>
                    <div className="lookalike-meta">
                        <span>{org.city}, {org.state}</span>
                        <span>{org.specialty || 'N/A'}</span>
                        <span>{org.physician_count} physicians</span>
                        <span>{org.similarity_score}% match</span>
                        {org.ehr && <span>EHR: {org.ehr}</span>}
                        {org.website && <span><a href={org.website.startsWith('http') ? org.website : `https://${org.website}`} target="_blank" rel="noopener noreferrer">{org.website}</a></span>}
                    </div>
                    {org.match_reasons && org.match_reasons.length > 0 && (
                        <div className="match-reasons">
                            {org.match_reasons.join(' · ')}
                        </div>
                    )}
                    {contacts.length > 0 && (
                        <>
                            <div className="contacts-toggle" onClick={() => setContactsOpen(!contactsOpen)}>
                                <span>{contacts.length} contact{contacts.length !== 1 ? 's' : ''}</span>
                                <span className={contactsOpen ? 'toggle-icon expanded' : 'toggle-icon'}>&#9660;</span>
                            </div>
                            {contactsOpen && (
                                <div className="contacts-list">
                                    <div className="contact-row contact-row-header">
                                        <span>Name</span>
                                        <span>Title</span>
                                        <span>Email(s)</span>
                                        <span>Phone(s)</span>
                                        <span>Links</span>
                                    </div>
                                    {contacts.map((c, ci) => (
                                        <div key={ci} className="contact-row">
                                            <span className="contact-name">
                                                {c.name}
                                                <br/>
                                                <span className={`contact-badge ${c.type}`}>{c.type}</span>
                                            </span>
                                            <span className="contact-title">{c.title || '—'}</span>
                                            <EmailList c={c} />
                                            <PhoneList c={c} />
                                            <span>
                                                {c.linkedin ? (
                                                    <a href={c.linkedin} target="_blank" rel="noopener noreferrer">LinkedIn</a>
                                                ) : '—'}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    )}

                    {/* ── Clay Contact Search ──── */}
                    <div className="clay-search-section">
                        <div className="clay-search-header">
                            <span className="clay-search-label">Clay Contacts</span>
                            <button
                                className="clay-seed-btn"
                                onClick={() => searchClayContacts(false)}
                                disabled={loadingClaySearch || !org.website}
                                title={org.website ? `Search Clay for contacts at ${org.website}` : 'No website — cannot search'}
                            >
                                {loadingClaySearch ? 'Searching...' : 'Search'}
                            </button>
                        </div>

                        {claySearchError && (
                            <div className="text-error">{claySearchError}</div>
                        )}

                        {showRerunPrompt && cachedSearchResult && (
                            <div className="clay-rerun-prompt">
                                <span>
                                    {new Date(cachedSearchResult.searched_at).toLocaleDateString()} — {(clayContacts || []).length} contact{(clayContacts || []).length !== 1 ? 's' : ''}
                                </span>
                                <button onClick={() => searchClayContacts(true)}>Re-run</button>
                            </div>
                        )}

                        {loadingClaySearch && !clayContacts && (
                            <div className="text-searching">Searching Clay...</div>
                        )}

                        {loadingClaySearch && clayContacts && clayContacts.length > 0 && (
                            <div className="text-searching">
                                Found {clayContacts.length} so far, still searching...
                            </div>
                        )}

                        {clayContacts && clayContacts.length > 0 && (
                            <div className="contacts-list">
                                <div className="contact-row contact-row-header">
                                    <span>Name</span>
                                    <span>Title</span>
                                    <span>Email(s)</span>
                                    <span>Phone(s)</span>
                                    <span>Links</span>
                                </div>
                                {clayContacts.map((c, idx) => (
                                    <div key={idx} className="contact-row">
                                        <span className="contact-name">{c.name || '—'}</span>
                                        <span className="contact-title">{c.title || '—'}</span>
                                        <span>
                                            {c.email ? <a href={`mailto:${c.email}`}>{c.email}</a> : '—'}
                                        </span>
                                        <span>{c.phone || '—'}</span>
                                        <span>
                                            {c.linkedin ? (
                                                <a href={c.linkedin.startsWith('http') ? c.linkedin : `https://${c.linkedin}`} target="_blank" rel="noopener noreferrer">LinkedIn</a>
                                            ) : '—'}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        )}

                        {clayContacts && clayContacts.length === 0 && !loadingClaySearch && (
                            <div className="text-muted text-small">No contacts found from Clay</div>
                        )}
                    </div>
                </div>
            );
        }

        function DealCard({ deal }) {
            const [expanded, setExpanded] = useState(false);
            const [lookalikes, setLookalikes] = useState(null);
            const [loadingLookalikes, setLoadingLookalikes] = useState(false);
            const lookalikePageRef = React.useRef(1);
            const lookalikesLoadedRef = React.useRef(false);
            const [lookalikeFilters, setLookalikeFilters] = useState({
                specialty: '',
                minMatch: '',
                city: '',
                state: ''
            });

            useEffect(() => {
                if (lookalikesLoadedRef.current) {
                    findLookalikes(true);
                }
            }, [lookalikeFilters.specialty, lookalikeFilters.minMatch, lookalikeFilters.city, lookalikeFilters.state]);

            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleDateString();
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            };

            const findLookalikes = async (resetPage) => {
                const effectiveState = deal.billing_state || deal.lc_us_state;
                const effectiveCity = deal.billing_city || deal.lc_city;

                if (!effectiveState) {
                    setLookalikes({ error: 'No state on this deal or associated company — cannot search for lookalikes' });
                    return;
                }
                if (resetPage) lookalikePageRef.current = 1;
                setLoadingLookalikes(true);
                try {
                    const params = new URLSearchParams();
                    params.append('billing_state', effectiveState);
                    if (effectiveCity) params.append('billing_city', effectiveCity);
                    if (deal.specialty_mcp_use) params.append('specialty', deal.specialty_mcp_use);
                    params.append('page', lookalikePageRef.current);
                    params.append('page_size', '10');

                    if (lookalikeFilters.specialty) params.append('filter_specialty', lookalikeFilters.specialty);
                    if (lookalikeFilters.minMatch) params.append('filter_min_match', lookalikeFilters.minMatch);
                    if (lookalikeFilters.city) params.append('filter_city', lookalikeFilters.city);
                    if (lookalikeFilters.state) params.append('filter_state', lookalikeFilters.state);

                    const response = await fetch(`${API_BASE_URL}/api/lookalikes?${params}`, { credentials: 'include' });
                    if (response.status === 401) { window.location.href = '/login.html'; return; }
                    const data = await response.json();
                    if (data.error) {
                        setLookalikes({ error: data.error });
                    } else {
                        setLookalikes(data);
                        lookalikesLoadedRef.current = true;
                    }
                } catch (error) {
                    console.error('Error fetching lookalikes:', error);
                    setLookalikes({ error: 'Failed to load lookalikes' });
                } finally {
                    setLoadingLookalikes(false);
                }
            };

            const filterOpts = (lookalikes && lookalikes.filter_options) || {};
            const lookalikeSpecialties = filterOpts.specialties || [];
            const lookalikeCities = filterOpts.cities || [];
            const lookalikeStates = filterOpts.states || [];

            return (
                <div className="deal-card">
                    <div className="deal-header-toggle" onClick={() => setExpanded(!expanded)}>
                        <div className="deal-title-section">
                            <h3>
                                <a href={deal.deal_url} target="_blank" rel="noopener noreferrer">
                                    {deal.deal_name}
                                </a>
                            </h3>
                            <span className="deal-amount">{formatCurrency(deal.amount)}</span>
                        </div>
                        <span className={`toggle-icon ${expanded ? 'expanded' : ''}`}>&#9660;</span>
                    </div>

                    <div className={`deal-content ${expanded ? 'expanded' : ''}`}>
                        <div className="deal-info-section">
                            <div className="deal-info-grid">
                                <div className="info-section">
                                    <h4>Company & Contact</h4>
                                    <div className="info-item">
                                        <span className="label">Company</span>
                                        <span>{deal.associated_company_name || 'N/A'}</span>
                                    </div>
                                    <div className="info-item">
                                        <span className="label">Contact</span>
                                        <span>{deal.associated_contact_email || 'N/A'}</span>
                                    </div>
                                </div>

                                <div className="info-section">
                                    <h4>Location</h4>
                                    <div className="info-item">
                                        <span className="label">City</span>
                                        <span>
                                            {deal.billing_city || deal.lc_city || 'N/A'}
                                            {!deal.billing_city && deal.lc_city && <span className="fallback-badge" title="From associated company LC City"> (Co.)</span>}
                                        </span>
                                    </div>
                                    <div className="info-item">
                                        <span className="label">State</span>
                                        <span>
                                            {deal.billing_state || deal.lc_us_state || 'N/A'}
                                            {!deal.billing_state && deal.lc_us_state && <span className="fallback-badge" title="From associated company LC US State"> (Co.)</span>}
                                        </span>
                                    </div>
                                    <div className="info-item">
                                        <span className="label">Country</span>
                                        <span>{deal.country || 'N/A'}</span>
                                    </div>
                                </div>

                                <div className="info-section">
                                    <h4>Medical Info</h4>
                                    <div className="info-item">
                                        <span className="label">Specialty</span>
                                        <span>{deal.specialty_mcp_use || 'N/A'}</span>
                                    </div>
                                    <div className="info-item">
                                        <span className="label">EHR</span>
                                        <span>{deal.ehr || 'N/A'}</span>
                                    </div>
                                </div>

                                <div className="info-section">
                                    <h4>Product & Seats</h4>
                                    <div className="info-item">
                                        <span className="label">Product</span>
                                        <span>{deal.product || 'N/A'}</span>
                                    </div>
                                    <div className="info-item">
                                        <span className="label">Seats</span>
                                        <span>{deal.seats}</span>
                                    </div>
                                    <div className="info-item">
                                        <span className="label">TSO</span>
                                        <span>{deal.tso}</span>
                                    </div>
                                </div>

                                <div className="info-section">
                                    <h4>Owner & Pipeline</h4>
                                    <div className="info-item">
                                        <span className="label">Owner</span>
                                        <span>{deal.owner_name || 'N/A'}</span>
                                    </div>
                                    <div className="info-item">
                                        <span className="label">Pipeline</span>
                                        <span>{deal.pipeline_name || 'N/A'}</span>
                                    </div>
                                    <div className="info-item">
                                        <span className="label">Stage</span>
                                        <span>{deal.dealstage_name || 'N/A'}</span>
                                    </div>
                                </div>

                                <div className="info-section">
                                    <h4>Dates</h4>
                                    <div className="info-item">
                                        <span className="label">Closed</span>
                                        <span>{formatDate(deal.close_date)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="lookalike-section">
                            <div className="lookalike-header">
                                <h4>Lookalike Companies</h4>
                                <button
                                    className="find-lookalikes-btn"
                                    onClick={() => findLookalikes(true)}
                                    disabled={loadingLookalikes}
                                >
                                    {loadingLookalikes ? 'Finding...' : 'Find Lookalikes'}
                                </button>
                            </div>

                            {!lookalikes && !loadingLookalikes && (
                                <div className="lookalike-placeholder">
                                    Click "Find Lookalikes" to discover similar companies
                                </div>
                            )}

                            {loadingLookalikes && (
                                <div className="lookalike-placeholder loading">
                                    Searching for similar companies...
                                </div>
                            )}

                            {lookalikes && !loadingLookalikes && (
                                <div className="lookalike-results">
                                    {lookalikes.error ? (
                                        <div className="lookalike-placeholder">{lookalikes.error}</div>
                                    ) : (lookalikes.total_unfiltered === 0 || (!lookalikes.lookalikes && !lookalikes.total_unfiltered)) ? (
                                        <div className="lookalike-placeholder">No lookalikes found</div>
                                    ) : (
                                        <>
                                            <div className="lookalike-summary">
                                                {(lookalikeFilters.specialty || lookalikeFilters.minMatch || lookalikeFilters.city || lookalikeFilters.state)
                                                    ? `${lookalikes.total_matches} matches (filtered from ${lookalikes.total_unfiltered}) — page ${lookalikes.page} of ${Math.max(lookalikes.total_pages, 1)}`
                                                    : `Showing page ${lookalikes.page} of ${lookalikes.total_pages} (${lookalikes.total_matches} total matches)`
                                                }
                                            </div>
                                            {lookalikes.expanded_specialties && lookalikes.expanded_specialties.length > 0 && (
                                                <div className="expanded-specialties-note">
                                                    Also searching medically related specialties: {lookalikes.expanded_specialties.join(', ')}
                                                </div>
                                            )}

                                            <div className="lookalike-filters">
                                                <select value={lookalikeFilters.specialty}
                                                    onChange={e => setLookalikeFilters(f => ({...f, specialty: e.target.value}))}>
                                                    <option value="">All Specialties</option>
                                                    {lookalikeSpecialties.map(s => <option key={s} value={s}>{s}</option>)}
                                                </select>
                                                <select value={lookalikeFilters.minMatch}
                                                    onChange={e => setLookalikeFilters(f => ({...f, minMatch: e.target.value}))}>
                                                    <option value="">Min Match %</option>
                                                    <option value="95">&ge; 95%</option>
                                                    <option value="85">&ge; 85%</option>
                                                    <option value="75">&ge; 75%</option>
                                                    <option value="65">&ge; 65%</option>
                                                    <option value="55">&ge; 55%</option>
                                                </select>
                                                <select value={lookalikeFilters.city}
                                                    onChange={e => setLookalikeFilters(f => ({...f, city: e.target.value}))}>
                                                    <option value="">All Cities</option>
                                                    {lookalikeCities.map(c => <option key={c} value={c}>{c}</option>)}
                                                </select>
                                                <select value={lookalikeFilters.state}
                                                    onChange={e => setLookalikeFilters(f => ({...f, state: e.target.value}))}>
                                                    <option value="">All States</option>
                                                    {lookalikeStates.map(s => <option key={s} value={s}>{s}</option>)}
                                                </select>
                                                {(lookalikeFilters.specialty || lookalikeFilters.minMatch || lookalikeFilters.city || lookalikeFilters.state) && (
                                                    <button className="lookalike-filter-clear"
                                                        onClick={() => setLookalikeFilters({specialty: '', minMatch: '', city: '', state: ''})}>
                                                        Clear
                                                    </button>
                                                )}
                                            </div>

                                            {lookalikes.lookalikes && lookalikes.lookalikes.length > 0 ? (
                                                lookalikes.lookalikes.map((org, idx) => (
                                                    <LookalikeCard key={idx} org={org} />
                                                ))
                                            ) : (
                                                <div className="lookalike-placeholder">No matches for current filters — try adjusting or clearing filters</div>
                                            )}
                                            {lookalikes.total_pages > 1 && (
                                                <div className="pagination">
                                                    <button
                                                        className="find-lookalikes-btn"
                                                        disabled={lookalikes.page <= 1}
                                                        onClick={() => { lookalikePageRef.current = lookalikes.page - 1; findLookalikes(false); }}
                                                    >
                                                        Previous
                                                    </button>
                                                    <button
                                                        className="find-lookalikes-btn"
                                                        disabled={lookalikes.page >= lookalikes.total_pages}
                                                        onClick={() => { lookalikePageRef.current = lookalikes.page + 1; findLookalikes(false); }}
                                                    >
                                                        Next
                                                    </button>
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            )}
                        </div>

                    </div>
                </div>
            );
        }

        function DealsDashboard() {
            const [deals, setDeals] = useState([]);
            const [loading, setLoading] = useState(false);
            const [filterOptions, setFilterOptions] = useState({});

            const [filters, setFilters] = useState({
                days_back: 14,
                deal_stage: '',
                specialty_mcp_use: '',
                country: 'United States',
                billing_state: '',
                billing_city: '',
                min_seats: '5',
                min_tso: '',
                product: '',
                pipeline: '',
                owner: ''
            });

            const fetchFilterOptions = async () => {
                try {
                    const params = new URLSearchParams();
                    Object.entries(filters).forEach(([key, value]) => {
                        if (key === 'owner') return;
                        if (value && value !== 'None' && value !== 'null') {
                            params.append(key, value);
                        }
                    });

                    const response = await fetch(`${API_BASE_URL}/api/filters?${params}`, { credentials: 'include' });
                    if (response.status === 401) { window.location.href = '/login.html'; return; }
                    const data = await response.json();
                    setFilterOptions(data);
                } catch (error) {
                    console.error('Error fetching filter options:', error);
                }
            };

            const fetchDeals = async () => {
                setLoading(true);

                try {
                    const params = new URLSearchParams();
                    Object.entries(filters).forEach(([key, value]) => {
                        if (key === 'owner') return;
                        if (value && value !== 'None' && value !== 'null') {
                            params.append(key, value);
                        }
                    });

                    const response = await fetch(`${API_BASE_URL}/api/deals?${params}`, { credentials: 'include' });
                    if (response.status === 401) { window.location.href = '/login.html'; return; }
                    const data = await response.json();

                    setDeals(data);
                } catch (error) {
                    console.error('Error fetching deals:', error);
                } finally {
                    setLoading(false);
                }
            };

            const updateFilter = (key, value) => {
                const cleanValue = value === 'None' || value === 'null' ? '' : value;
                setFilters(prev => ({ ...prev, [key]: cleanValue }));
            };

            const ownerOptions = [...new Set(deals.map(d => d.owner_name).filter(Boolean))].sort();

            const filteredDeals = filters.owner
                ? deals.filter(d => d.owner_name === filters.owner)
                : deals;

            useEffect(() => {
                fetchFilterOptions();
                fetchDeals();
            }, [filters.days_back, filters.deal_stage, filters.specialty_mcp_use, filters.country, filters.billing_state, filters.billing_city, filters.min_seats, filters.min_tso, filters.product, filters.pipeline]);

            return (
                <div className="dashboard">
                    <header className="dashboard-header">
                        <button className="logout-btn" onClick={handleLogout}>Sign Out</button>
                        <h1>Deals Dashboard</h1>
                        <p>Filter and view deals, discover lookalike companies</p>
                    </header>

                    <section className="filters-section">
                        <div className="filters-section-title">Filters</div>
                        <div className="filters-grid">
                            <div className="filter-group">
                                <label>Time Period</label>
                                <select value={filters.days_back} onChange={(e) => updateFilter('days_back', e.target.value)}>
                                    <option value="7">Last 7 days</option>
                                    <option value="14">Last 14 days</option>
                                    <option value="30">Last 30 days</option>
                                    <option value="60">Last 60 days</option>
                                    <option value="90">Last 90 days</option>
                                </select>
                            </div>

                            <div className="filter-group">
                                <label>Deal Stage</label>
                                <select value={filters.deal_stage} onChange={(e) => updateFilter('deal_stage', e.target.value)}>
                                    <option value="">All Stages</option>
                                    {filterOptions.deal_stages?.map(stage => (
                                        <option key={stage.id} value={stage.id}>
                                            {stage.label} ({stage.pipeline})
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="filter-group">
                                <label>Pipeline</label>
                                <select value={filters.pipeline} onChange={(e) => updateFilter('pipeline', e.target.value)}>
                                    <option value="">All Pipelines</option>
                                    {filterOptions.pipelines?.map(p => (
                                        <option key={p.id} value={p.name}>{p.name}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="filter-group">
                                <label>Deal Owner</label>
                                <select value={filters.owner} onChange={(e) => updateFilter('owner', e.target.value)}>
                                    <option value="">All Owners</option>
                                    {ownerOptions.map(o => (
                                        <option key={o} value={o}>{o}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="filter-group">
                                <label>Specialty</label>
                                <select value={filters.specialty_mcp_use} onChange={(e) => updateFilter('specialty_mcp_use', e.target.value)}>
                                    <option value="">All Specialties</option>
                                    {filterOptions.specialties?.map(s => (
                                        <option key={s} value={s}>{s}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="filter-group">
                                <label>Country</label>
                                <select value={filters.country} onChange={(e) => updateFilter('country', e.target.value)}>
                                    <option value="">All Countries</option>
                                    {filterOptions.countries?.map(c => (
                                        <option key={c} value={c}>{c}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="filter-group">
                                <label>State</label>
                                <select value={filters.billing_state} onChange={(e) => updateFilter('billing_state', e.target.value)}>
                                    <option value="">All States</option>
                                    {filterOptions.billing_states?.map(s => (
                                        <option key={s} value={s}>{s}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="filter-group">
                                <label>City</label>
                                <select value={filters.billing_city} onChange={(e) => updateFilter('billing_city', e.target.value)}>
                                    <option value="">All Cities</option>
                                    {filterOptions.billing_cities?.map(c => (
                                        <option key={c} value={c}>{c}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="filter-group">
                                <label>Product</label>
                                <select value={filters.product} onChange={(e) => updateFilter('product', e.target.value)}>
                                    <option value="">All Products</option>
                                    {filterOptions.products?.map(p => (
                                        <option key={p} value={p}>{p}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="filter-group">
                                <label>Min Seats</label>
                                <input
                                    type="number"
                                    value={filters.min_seats}
                                    onChange={(e) => updateFilter('min_seats', e.target.value)}
                                    placeholder="e.g., 5"
                                />
                            </div>

                            <div className="filter-group">
                                <label>Min TSO</label>
                                <input
                                    type="number"
                                    value={filters.min_tso}
                                    onChange={(e) => updateFilter('min_tso', e.target.value)}
                                    placeholder="e.g., 10"
                                />
                            </div>
                        </div>
                    </section>

                    <section className="results-section">
                        <div className="results-header">
                            <h2>Results ({filteredDeals.length}{filters.owner ? ` of ${deals.length}` : ''} deals)</h2>
                            {loading && <span className="loading">Loading...</span>}
                        </div>

                        <div className="deals-grid">
                            {filteredDeals.map(deal => (
                                <DealCard key={deal.deal_id} deal={deal} />
                            ))}
                        </div>

                        {filteredDeals.length === 0 && !loading && (
                            <div className="no-results">
                                <p>No deals found matching your filters</p>
                            </div>
                        )}
                    </section>
                </div>
            );
        }

        ReactDOM.render(<DealsDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
